# =============================================================================
# Terrarium Git - Docker Compose Stack
# =============================================================================
# Domain: terrarium-git.terrarium.network
# Components: PostgreSQL, Gitea, Nginx, Runners, Buildx, Watchtower
# =============================================================================

networks:
  gitea-network:
    driver: bridge

services:
  # ===========================================================================
  # POSTGRESQL - Database
  # ===========================================================================
  postgres:
    image: postgres:${POSTGRES_VERSION:-17-alpine}
    container_name: terrarium-git-postgres
    restart: always
    environment:
      POSTGRES_DB: gitea
      POSTGRES_USER: gitea
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - gitea-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U gitea -d gitea" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # GITEA - Git Server
  # ===========================================================================
  gitea:
    image: gitea/gitea:${GITEA_VERSION:-1.23}
    container_name: terrarium-git-server
    restart: always
    ports:
      - "${SSH_PORT:-2222}:2222"
    environment:
      - USER_UID=1000
      - USER_GID=1000
      # Database
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=postgres:5432
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=${POSTGRES_PASSWORD}
      # Server
      - GITEA__server__DOMAIN=${DOMAIN:-terrarium-git.terrarium.network}
      - GITEA__server__ROOT_URL=${ROOT_URL:-https://terrarium-git.terrarium.network/}
      - GITEA__server__HTTP_PORT=3000
      - GITEA__server__SSH_DOMAIN=${DOMAIN:-terrarium-git.terrarium.network}
      - GITEA__server__SSH_PORT=${SSH_PORT:-2222}
      - GITEA__server__SSH_LISTEN_PORT=2222
      - GITEA__server__START_SSH_SERVER=true
      - GITEA__server__LFS_START_SERVER=true
      - GITEA__server__OFFLINE_MODE=false
      # LFS
      - GITEA__lfs__PATH=/data/lfs
      # Security
      - GITEA__security__INSTALL_LOCK=true
      # Service
      - GITEA__service__DISABLE_REGISTRATION=false
      - GITEA__service__REQUIRE_SIGNIN_VIEW=false
      - GITEA__service__ENABLE_NOTIFY_MAIL=true
      # OAuth2 / OIDC
      - GITEA__oauth2__ENABLE=true
      # Actions
      - GITEA__actions__ENABLED=true
      - GITEA__actions__DEFAULT_ACTIONS_URL=github
      # Repository
      - GITEA__repository__DEFAULT_REPO_UNITS=repo.code,repo.issues,repo.pulls,repo.releases,repo.wiki,repo.projects,repo.actions
      - GITEA__repository__ENABLE_PUSH_CREATE_USER=true
      - GITEA__repository__ENABLE_PUSH_CREATE_ORG=true
      - GITEA__repository__DEFAULT_PUSH_CREATE_PRIVATE=false
      # Mailer
      - GITEA__mailer__ENABLED=${SMTP_ENABLED:-true}
      - GITEA__mailer__PROTOCOL=smtps
      - GITEA__mailer__SMTP_ADDR=${SMTP_HOST:-email-smtp.us-east-1.amazonaws.com}
      - GITEA__mailer__SMTP_PORT=${SMTP_PORT:-587}
      - GITEA__mailer__USER=${SMTP_USER}
      - GITEA__mailer__PASSWD=${SMTP_PASSWORD}
      - GITEA__mailer__FROM=${SMTP_FROM:-noreply@terrarium.network}
      # Logging
      - GITEA__log__MODE=console
      - GITEA__log__LEVEL=info
    volumes:
      - gitea-data:/data
      - gitea-lfs:/data/lfs
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - gitea-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:3000/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================================================
  # NGINX - Reverse Proxy (handles large uploads, WebSocket)
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: terrarium-git-nginx
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - gitea-network
    depends_on:
      gitea:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:3000/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # ACT RUNNER 1 - Build Agent
  # ===========================================================================
  runner1:
    image: gitea/act_runner:${RUNNER_VERSION:-latest}
    container_name: terrarium-git-runner-1
    restart: always
    environment:
      - GITEA_INSTANCE_URL=http://gitea:3000
      - GITEA_RUNNER_REGISTRATION_TOKEN=${RUNNER_TOKEN}
      - CONFIG_FILE=/config.yaml
      - GITEA_RUNNER_NAME=runner-1
      - GITEA_RUNNER_LABELS=ubuntu-latest:docker://docker.gitea.com/runner-images:ubuntu-latest,ubuntu-22.04:docker://docker.gitea.com/runner-images:ubuntu-22.04,ubuntu-24.04:docker://docker.gitea.com/runner-images:ubuntu-24.04
    volumes:
      - runner1-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config.yaml:/config.yaml:ro
    networks:
      - gitea-network
    depends_on:
      gitea:
        condition: service_healthy

  # ===========================================================================
  # ACT RUNNER 2 - Build Agent
  # ===========================================================================
  runner2:
    image: gitea/act_runner:${RUNNER_VERSION:-latest}
    container_name: terrarium-git-runner-2
    restart: always
    environment:
      - GITEA_INSTANCE_URL=http://gitea:3000
      - GITEA_RUNNER_REGISTRATION_TOKEN=${RUNNER_TOKEN}
      - CONFIG_FILE=/config.yaml
      - GITEA_RUNNER_NAME=runner-2
      - GITEA_RUNNER_LABELS=ubuntu-latest:docker://docker.gitea.com/runner-images:ubuntu-latest,ubuntu-22.04:docker://docker.gitea.com/runner-images:ubuntu-22.04,ubuntu-24.04:docker://docker.gitea.com/runner-images:ubuntu-24.04
    volumes:
      - runner2-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config.yaml:/config.yaml:ro
    networks:
      - gitea-network
    depends_on:
      gitea:
        condition: service_healthy

  # ===========================================================================
  # BUILDX - Multi-architecture Build Support
  # ===========================================================================
  buildx:
    image: moby/buildkit:buildx-stable-1
    container_name: terrarium-git-buildx
    restart: always
    privileged: true
    volumes:
      - buildx-data:/var/lib/buildkit
    networks:
      - gitea-network

  # ===========================================================================
  # WATCHTOWER - Automatic Container Updates
  # ===========================================================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: terrarium-git-watchtower
    restart: always
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_ROLLING_RESTART=true
      - TZ=UTC
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

volumes:
  postgres-data:
    driver: local
  gitea-data:
    driver: local
  gitea-lfs:
    driver: local
  runner1-data:
    driver: local
  runner2-data:
    driver: local
  buildx-data:
    driver: local
