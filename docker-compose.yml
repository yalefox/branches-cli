# =============================================================================
# Terrarium Git - Docker Compose Stack
# =============================================================================
# Domain: terrarium-git.terrarium.network
# Components: PostgreSQL, Gitea, Nginx, MinIO, Runners, Buildx, Watchtower
# =============================================================================

networks:
  gitea-network:
    driver: bridge

services:
  # ===========================================================================
  # POSTGRESQL - Database
  # ===========================================================================
  postgres:
    image: postgres:${POSTGRES_VERSION:-17-alpine}
    container_name: terrarium-git-postgres
    restart: always
    environment:
      POSTGRES_DB: gitea
      POSTGRES_USER: gitea
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ${POSTGRES_DATA:-postgres-data}:/var/lib/postgresql/data
    networks:
      - gitea-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U gitea -d gitea" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # MINIO - S3-Compatible Object Storage for Git LFS
  # ===========================================================================
  minio:
    image: minio/minio:${MINIO_VERSION:-latest}
    container_name: terrarium-git-minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      # OIDC Configuration
      MINIO_IDENTITY_OPENID_CONFIG_URL: ${MINIO_OIDC_CONFIG_URL:-https://auth.terrarium.network/.well-known/openid-configuration}
      MINIO_IDENTITY_OPENID_CLIENT_ID: ${MINIO_OIDC_CLIENT_ID}
      MINIO_IDENTITY_OPENID_CLIENT_SECRET: ${MINIO_OIDC_CLIENT_SECRET}
      MINIO_IDENTITY_OPENID_CLAIM_NAME: ${MINIO_OIDC_CLAIM_NAME:-policy}
      MINIO_IDENTITY_OPENID_SCOPES: ${MINIO_OIDC_SCOPES:-openid,profile,email}
      MINIO_IDENTITY_OPENID_REDIRECT_URI: https://${MINIO_DOMAIN:-terrarium-git-minio1.terrarium.network}/oauth_callback
      MINIO_BROWSER_REDIRECT_URL: https://${MINIO_DOMAIN:-terrarium-git-minio1.terrarium.network}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - ${MINIO_DATA:-minio-data}:/data
      - ./root-ca.pem:/root/.minio/certs/CAs/root-ca.pem:ro
    networks:
      - gitea-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # GITEA - Git Server
  # ===========================================================================
  gitea:
    image: gitea/gitea:${GITEA_VERSION:-1.23}
    container_name: terrarium-git-server
    restart: always
    ports:
      - "${SSH_PORT:-2222}:2222"
    environment:
      - USER_UID=1000
      - USER_GID=1000
      # Database
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=postgres:5432
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=${POSTGRES_PASSWORD}
      # Server
      - GITEA__server__DOMAIN=${DOMAIN:-terrarium-git.terrarium.network}
      - GITEA__server__ROOT_URL=${ROOT_URL:-https://terrarium-git.terrarium.network/}
      - GITEA__server__HTTP_PORT=3000
      - GITEA__server__SSH_DOMAIN=${DOMAIN:-terrarium-git.terrarium.network}
      - GITEA__server__SSH_PORT=${SSH_PORT:-2222}
      - GITEA__server__SSH_LISTEN_PORT=2222
      - GITEA__server__START_SSH_SERVER=true
      - GITEA__server__LFS_START_SERVER=true
      - GITEA__server__OFFLINE_MODE=false
      # LFS - Using MinIO
      - GITEA__lfs__STORAGE_TYPE=minio
      - GITEA__lfs__MINIO_ENDPOINT=minio:9000
      - GITEA__lfs__MINIO_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - GITEA__lfs__MINIO_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - GITEA__lfs__MINIO_BUCKET=${MINIO_LFS_BUCKET:-terrarium-git-lfs-01}
      - GITEA__lfs__MINIO_LOCATION=us-east-1
      - GITEA__lfs__MINIO_USE_SSL=false
      # Security
      - GITEA__security__INSTALL_LOCK=true
      # Service
      - GITEA__service__DISABLE_REGISTRATION=false
      - GITEA__service__REQUIRE_SIGNIN_VIEW=false
      - GITEA__service__ENABLE_NOTIFY_MAIL=true
      # OAuth2 / OIDC
      - GITEA__oauth2__ENABLE=true
      # Actions
      - GITEA__actions__ENABLED=true
      - GITEA__actions__DEFAULT_ACTIONS_URL=github
      # Repository
      - GITEA__repository__DEFAULT_REPO_UNITS=repo.code,repo.issues,repo.pulls,repo.releases,repo.wiki,repo.projects,repo.actions
      - GITEA__repository__ENABLE_PUSH_CREATE_USER=true
      - GITEA__repository__ENABLE_PUSH_CREATE_ORG=true
      - GITEA__repository__DEFAULT_PUSH_CREATE_PRIVATE=false
      # Mailer
      - GITEA__mailer__ENABLED=${SMTP_ENABLED:-true}
      - GITEA__mailer__PROTOCOL=smtps
      - GITEA__mailer__SMTP_ADDR=${SMTP_HOST:-email-smtp.us-east-1.amazonaws.com}
      - GITEA__mailer__SMTP_PORT=${SMTP_PORT:-587}
      - GITEA__mailer__USER=${SMTP_USER}
      - GITEA__mailer__PASSWD=${SMTP_PASSWORD}
      - GITEA__mailer__FROM=${SMTP_FROM:-noreply@terrarium.network}
      # Logging
      - GITEA__log__MODE=console
      - GITEA__log__LEVEL=${LOG_LEVEL:-info}
    volumes:
      - ${GITEA_DATA:-gitea-data}:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      # SSH keys for runners
      - ./ssh:/data/git/.ssh:ro
    networks:
      - gitea-network
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:3000/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================================================
  # NGINX - Reverse Proxy (handles large uploads, WebSocket)
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: terrarium-git-nginx
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - gitea-network
    depends_on:
      gitea:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:3000/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # ACT RUNNER 1 - Build Agent
  # ===========================================================================
  runner1:
    image: gitea/act_runner:${RUNNER_VERSION:-latest}
    container_name: terrarium-git-runner-1
    restart: always
    environment:
      - GITEA_INSTANCE_URL=http://gitea:3000
      - GITEA_RUNNER_REGISTRATION_TOKEN=${RUNNER_TOKEN}
      - CONFIG_FILE=/config.yaml
      - GITEA_RUNNER_NAME=runner-1
      - GITEA_RUNNER_LABELS=ubuntu-latest:docker://docker.gitea.com/runner-images:ubuntu-latest,ubuntu-22.04:docker://docker.gitea.com/runner-images:ubuntu-22.04,ubuntu-24.04:docker://docker.gitea.com/runner-images:ubuntu-24.04
    volumes:
      - runner1-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config.yaml:/config.yaml:ro
      - ./ssh:/root/.ssh:ro
    networks:
      - gitea-network
    depends_on:
      gitea:
        condition: service_healthy

  # ===========================================================================
  # ACT RUNNER 2 - Build Agent
  # ===========================================================================
  runner2:
    image: gitea/act_runner:${RUNNER_VERSION:-latest}
    container_name: terrarium-git-runner-2
    restart: always
    environment:
      - GITEA_INSTANCE_URL=http://gitea:3000
      - GITEA_RUNNER_REGISTRATION_TOKEN=${RUNNER_TOKEN}
      - CONFIG_FILE=/config.yaml
      - GITEA_RUNNER_NAME=runner-2
      - GITEA_RUNNER_LABELS=ubuntu-latest:docker://docker.gitea.com/runner-images:ubuntu-latest,ubuntu-22.04:docker://docker.gitea.com/runner-images:ubuntu-22.04,ubuntu-24.04:docker://docker.gitea.com/runner-images:ubuntu-24.04
    volumes:
      - runner2-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config.yaml:/config.yaml:ro
      - ./ssh:/root/.ssh:ro
    networks:
      - gitea-network
    depends_on:
      gitea:
        condition: service_healthy

  # ===========================================================================
  # BUILDX - Multi-architecture Build Support
  # ===========================================================================
  buildx:
    image: moby/buildkit:buildx-stable-1
    container_name: terrarium-git-buildx
    restart: always
    privileged: true
    volumes:
      - buildx-data:/var/lib/buildkit
    networks:
      - gitea-network

  # ===========================================================================
  # WATCHTOWER - Automatic Container Updates (disabled in production)
  # ===========================================================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: terrarium-git-watchtower
    restart: always
    profiles:
      - staging
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_ROLLING_RESTART=true
      - TZ=UTC
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - gitea-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ===========================================================================
  # WAZUH AGENT - Security Monitoring and Log Shipping
  # ===========================================================================
  # Sends logs to central Wazuh server at wazuh.terrarium.network
  wazuh-agent:
    image: wazuh/wazuh-agent:${WAZUH_VERSION:-4.14.1}
    container_name: terrarium-git-wazuh-agent
    restart: always
    hostname: ${DOMAIN:-terrarium-git.terrarium.network}
    environment:
      - WAZUH_MANAGER=${WAZUH_MANAGER:-wazuh.terrarium.network}
      - WAZUH_AGENT_GROUP=${WAZUH_AGENT_GROUP:-terrarium-services}
      - WAZUH_AGENT_NAME=${DOMAIN:-terrarium-git.terrarium.network}
    volumes:
      # Read logs from other containers
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      # Persist agent data
      - wazuh-agent-data:/var/ossec/data
      # Custom agent configuration
      - ./wazuh/ossec.conf:/var/ossec/etc/ossec.conf:ro
    networks:
      - gitea-network
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined

volumes:
  postgres-data:
    driver: local
  gitea-data:
    driver: local
  minio-data:
    driver: local
  runner1-data:
    driver: local
  runner2-data:
    driver: local
  buildx-data:
    driver: local
  wazuh-agent-data:
    driver: local
