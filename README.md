# Terrarium Git

**Self-hosted Git server with CI/CD, OIDC, and multi-arch builds**

- **Domain**: `terrarium-git.terrarium.network`
- **Stack**: Gitea + PostgreSQL 17 + Nginx + Act Runners + Buildx + Watchtower
- **Registry**: External Zot at `containers.terrarium.network`

---

## Quick Start

### Prerequisites
- Docker & Docker Compose
- 4+ cores, 8GB+ RAM recommended (2GB minimum)
- macOS (Docker Desktop) or Linux

### Installation

```bash
# Clone the repo
git clone https://git.terrarium.network/yalefox/terrarium-git_official.git
cd terrarium-git_official

# Run the installer
chmod +x 00-install-terrarium-git.sh
./00-install-terrarium-git.sh
```

The script will:
1. ✅ Check Docker is running
2. ✅ Install Terrarium root CA
3. ✅ Generate secure passwords (idempotent)
4. ✅ Start PostgreSQL, Gitea, Nginx, Buildx, Watchtower
5. ✅ Create admin user
6. ✅ Configure OIDC (Pocket ID)

### Configure Runners

After first start, configure CI/CD runners:

1. Go to: https://terrarium-git.terrarium.network/admin/actions/runners
2. Click "Create new Runner" → Copy token
3. Run: `./scripts/setup-runners.sh <TOKEN>`

---

## Traefik Route Configuration (Checkpoint/Mantrae)

Mantrae manages Traefik routes at: **https://checkpoint.terrarium.network**

### Adding terrarium-git Route

1. Login to Mantrae: https://checkpoint.terrarium.network
2. Navigate to **Routers** → **Add Router**
3. Configure:

| Field | Value |
|-------|-------|
| **Name** | `terrarium-git` |
| **Rule** | `Host(\`terrarium-git.terrarium.network\`)` |
| **Service** | Create new: `terrarium-git-svc` |
| **Service URL** | `http://<server-ip>:3000` |
| **Entrypoints** | `websecure` |
| **TLS** | ✅ Enabled |
| **Cert Resolver** | `letsencrypt` (or your resolver) |

4. Save → Traefik polls and applies automatically

### Adding SSH Route (Port 2222)

For SSH git clone, add a **TCP Router**:

| Field | Value |
|-------|-------|
| **Name** | `terrarium-git-ssh` |
| **Rule** | `HostSNI(\`*\`)` |
| **Service** | `terrarium-git-ssh-svc` → `<server-ip>:2222` |
| **Entrypoints** | `ssh` (you may need to add this entrypoint) |

### DNS Records

Add to your DNS provider (PowerDNS/Cloudflare via Mantrae or manually):

| Type | Name | Value |
|------|------|-------|
| A | `terrarium-git.terrarium.network` | `<checkpoint-ip>` |

### Verify Route

Check Mantrae API:
```bash
curl "https://checkpoint.terrarium.network/api/default?token=b5pk6roume"
```

---

## Environment Variables

Copy `.env.example` to `.env` and configure:

```bash
# Required - auto-generated on first run
POSTGRES_PASSWORD=<auto-generated>
ADMIN_PASSWORD=<auto-generated>

# Runner token - get from Gitea admin UI
RUNNER_TOKEN=<from-gitea-admin>

# OIDC - pre-configured for Pocket ID
OIDC_CLIENT_ID=3b5ec0af-31c0-4950-99e4-1627b7b7dd41
OIDC_CLIENT_SECRET=yRtLbrGE72yyeDjZ7R6L0YlKAVLWBmBy

# Email - AWS SES
SMTP_HOST=email-smtp.us-east-1.amazonaws.com
SMTP_USER=<your-ses-user>
SMTP_PASSWORD=<your-ses-password>
```

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    External Traffic                          │
│         https://terrarium-git.terrarium.network              │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│  Checkpoint (Traefik) - TLS Termination                      │
│  https://checkpoint.terrarium.network (Mantrae UI)           │
└──────────────────────────┬──────────────────────────────────┘
                           │ :3000
                           ▼
┌──────────────────────────────────────────────────────────────┐
│  terrarium-git-nginx (Nginx)                                 │
│  - 5GB upload limit                                          │
│  - WebSocket support                                         │
│  - Extended timeouts                                         │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│  terrarium-git-server (Gitea 1.23)                           │
│  - Git repositories                                          │
│  - LFS objects                                               │
│  - Actions/CI-CD                                             │
│  - OIDC authentication                                       │
└──────────┬─────────────────────────────────┬────────────────┘
           │                                 │
           ▼                                 ▼
┌──────────────────────┐          ┌────────────────────────────┐
│  PostgreSQL 17       │          │  Act Runners (x2)          │
│  - User accounts     │          │  - ubuntu-latest           │
│  - Issues, PRs       │          │  - Docker-in-Docker        │
│  - Repo metadata     │          │  - Multi-arch via Buildx   │
└──────────────────────┘          └────────────────────────────┘
                                             │
                                             ▼
                                  ┌────────────────────────────┐
                                  │  containers.terrarium.net  │
                                  │  (Zot Registry)            │
                                  └────────────────────────────┘
```

---

## Data Storage

| Data | Location | Backup Method |
|------|----------|---------------|
| Git repos | `gitea-data` volume | `git bundle` or volume backup |
| LFS objects | `gitea-lfs` volume | Volume backup (→ MinIO planned) |
| Database | `postgres-data` volume | `pg_dump` (small, fast) |
| Config | `.env`, `.password` | File copy |

---

## Scripts

| Script | Purpose |
|--------|---------|
| `00-install-terrarium-git.sh` | Main installer (macOS/Linux) |
| `scripts/setup-runners.sh <TOKEN>` | Configure CI/CD runners |
| `scripts/backup.sh` | Backup database + data |
| `scripts/update.sh` | Pull latest images, restart |

---

## Management Commands

```bash
# View status
docker compose ps

# View logs
docker compose logs -f gitea

# Restart all
docker compose restart

# Stop all
docker compose down

# Destroy everything (CAREFUL!)
./00-install-terrarium-git.sh --destroy
```

---

## Backup Strategy

### Current: Local Backup
```bash
./scripts/backup.sh
# Creates: backups/terrarium-git_backup_YYYYMMDD_HHMMSS.tar.gz
```

### Recommended: Restic/Borg (TODO)
For production, configure Restic or Borg to:
- Backup to external S3/MinIO
- Deduplicated, encrypted
- Scheduled via cron

Example Restic setup:
```bash
# Initialize repo (once)
restic -r s3:s3.amazonaws.com/your-bucket/terrarium-git init

# Backup
restic -r s3:s3.amazonaws.com/your-bucket/terrarium-git backup \
  /var/lib/docker/volumes/terrarium-git_gitea-data \
  /var/lib/docker/volumes/terrarium-git_postgres-data
```

---

## Ansible Deployment

For production Linux servers:

```bash
# Edit inventory
vim ansible/inventory.yml

# Deploy
ansible-playbook -i ansible/inventory.yml ansible/playbook.yml
```

---

## Troubleshooting

### Docker not running (macOS)
```bash
open -a Docker  # Start Docker Desktop
```

### Gitea not healthy
```bash
docker logs terrarium-git-server --tail 50
```

### Runner not connecting
1. Check token is correct in `.env`
2. Ensure `RUNNER_TOKEN` is set
3. Restart runners: `docker compose restart runner1 runner2`

### OIDC not working
1. Verify OIDC credentials in `.env`
2. Check auth sources: `docker exec terrarium-git-server gitea admin auth list`

---

## Version History

- **v0.1.0** - Initial consolidated release
  - Docker Compose stack
  - PostgreSQL 17, Gitea 1.23
  - OIDC, AWS SES, Watchtower
  - macOS + Linux support
  - Ansible playbook

---

## License

MIT - Terrarium Network
